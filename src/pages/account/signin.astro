---
import { SESSION_COOKIE, createAdminClient } from "../../server/appwrite.js";
import { AppwriteException, ID } from "node-appwrite";
import Layout from "../../layouts/Layout.astro";

const { user } = Astro.locals;
if (user) {
    return Astro.redirect("/account");
}

var errors = "";
if (Astro.request.method === "POST") {
    // Extract the form data
    const data = await Astro.request.formData();
    const email = data.get("email")!.toString();
    const password = data.get("password")!.toString();

    // Create the admin client
    const { account } = createAdminClient();

    try {
        // Create the email password session
        const session = await account.createEmailPasswordSession(
            email,
            password,
        );

        // Set the session cookie
        Astro.cookies.set(SESSION_COOKIE, session.secret, {
            path: "/",
            expires: new Date(session.expire),
            sameSite: "strict",
            secure: true,
            httpOnly: true,
        });

        // Redirect to the account page
        return Astro.redirect("/account");
    } catch (error) {
        if (error instanceof AppwriteException) {
            errors += error.message;
            console.error(error);
        } else {
            console.error(error);
        }
    }
}
---

<Layout>
    <div class="flex items-center justify-center">
        <div class="w-full max-w-md bg-base-300 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-white text-center">Login</h2>
            <p class="mt-2 text-center text-gray-400">Access your account</p>
            <form class="mt-4" method="POST">
            <div class="flex flex-col mb-4">
                <input
                id="email" name="email" placeholder="Email" type="email" 
                class="px-3 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
                required
                />
            </div>
            <div class="flex flex-col mb-6">
                <input
                id="password"
                name="password"
                placeholder="Password"
                type="password"
                class="px-3 py-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
                required
                />
            </div>
            <button type="submit" class="w-full py-2 px-4 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">
                Sign in
            </button>
            <p class="text-center text-indigo-500 pt-1"><a href="/account/signup">Create a new Account</a></p>
            {errors && <p class="pt-2 px-4 text-red-600 text-center">{errors}</p>}
            </form>
        </div>
    </div>
</Layout>
